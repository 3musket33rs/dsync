<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/bucketSelector.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/bucketSelector.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(function () {
  'use strict';

  /**
   * Bucket selector interface.
   *
   * @class BucketSelector
   */
  /**
   * Selects buckets to store items in.
   *
   * &lt;p>This interface leaks internal details about summary structure. One can implement and use custom instances to
   * customize settings but be ready for major changes in following versions.&lt;/p>
   *
   * &lt;p>The output array must contain integers between &lt;code>0&lt;/code> and &lt;code>Integer.MAX_VALUE&lt;/code>. It is better
   * if all integers in that range have the same probability of appearance.&lt;/p>
   *
   * &lt;p>The output must be consistent, for any byte array&lt;code>content&lt;/code>, for any positive integer &lt;code>b&lt;/code>,
   * multiple invocations of &lt;code>selectBuckets(b, content)&lt;/code> must return the same array.&lt;/p>
   *
   * &lt;p>Different seed values should lead to different resulting arrays.&lt;/p>
   *
   * &lt;p>The number of returned buckets may vary for different contents and the returned array may contain
   * duplicates.&lt;/p>
   *
   * @name BucketSelector~Selector
   * @function
   * @param {number} seed a seed preventing items to fall in the same buckets at all compression levels.
   * @param {external:ArrayBuffer} item - the item to serialize.
   * @return {number[]} buckets to store the item in.
   */

  var BYTES_PER_INT = 4;

  function bytesToInt(buffer) {
    var dv = new DataView(buffer);
    var buckets = [];
    for (var i = 0; i &lt; buffer.byteLength; i += BYTES_PER_INT) {
      buckets.push(Math.abs(dv.getInt32(i)));
    }
    return buckets;
  }

  function padAndHash(digest, spread) {
    return function (seed, content) {
      var hashed;

      var remaining = spread * BYTES_PER_INT;
      var pointer = 0;
      var bucketsBytes = new Int8Array(remaining);

      var copy = new Int8Array(content.byteLength + BYTES_PER_INT);
      copy.set(new Int8Array(content));
      var dv = new DataView(copy.buffer);

      var pad = seed;
      while (true) {
        dv.setInt32(content.byteLength, pad++);
        hashed = new Int8Array(digest(copy.buffer));
        if (hashed.byteLength &lt; remaining) {
          bucketsBytes.set(hashed, pointer);
          pointer += hashed.byteLength;
          remaining -= hashed.byteLength;
        } else {
          bucketsBytes.set(hashed.subarray(0, remaining), pointer);
          return bytesToInt(bucketsBytes.buffer);
        }
      }
    };
  }

  module.exports = {

    /**
     * Selects multiple buckets to store items in by padding items and digesting them.
     *
     * @name module:mathsync/bucketSelector.padAndHash
     * @function
     * @param {digester} digest - digester for padded items.
     * @param {number} spread - the number of buckets to return.
     * @return {bucketSelector} a bucket selector.
     */
    padAndHash: padAndHash
  };
})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-mathsync.html">mathsync</a></li><li><a href="array.html">mathsync/array</a></li><li><a href="generator.html">mathsync/generator</a></li><li><a href="json.html">mathsync/json</a></li><li><a href="skeleton.html">mathsync/skeleton</a></li><li><a href="stream.html">mathsync/stream</a></li><li><a href="string.html">mathsync/string</a></li></ul><h3>Externals</h3><ul><li><a href="external-ArrayBuffer.html">ArrayBuffer</a></li><li><a href="external-Error.html">Error</a></li><li><a href="external-Generator.html">Generator</a></li><li><a href="external-Iterator.html">Iterator</a></li><li><a href="external-Promise.html">Promise</a></li><li><a href="external-Readable.html">Readable</a></li></ul><h3>Classes</h3><ul><li><a href="BucketSelector.html">BucketSelector</a></li><li><a href="Difference.html">Difference</a></li><li><a href="Digest.html">Digest</a></li><li><a href="Resolver.html">Resolver</a></li><li><a href="Serial.html">Serial</a></li><li><a href="Summarizer.html">Summarizer</a></li><li><a href="Summary.html">Summary</a></li></ul><h3>Events</h3><ul><li><a href="external-Readable.html#event:end">end</a></li><li><a href="external-Readable.html#event:error">error</a></li><li><a href="external-Readable.html#event:readable">readable</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Sat Jun 21 2014 11:45:16 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
